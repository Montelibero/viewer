<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Offer</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css?5">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4 is-flex is-justify-content-space-between is-align-items-center">
      <a class="button is-small is-light" href="/" data-i18n="back-home">На главную</a>
      <div class="buttons are-small" id="lang-switcher">
        <button class="button is-light" data-lang="ru">RU</button>
        <button class="button is-light" data-lang="en">EN</button>
        <button class="button is-light" data-lang="es">ES</button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5" data-i18n="header-title">Offer</p>
            <p class="subtitle is-7" id="offer-id">—</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label" data-i18n="status-loading">Loading…</span>
        </div>
      </div>

      <p class="is-size-7">
        <span data-i18n="seller-label">Продавец:</span>
        <span id="seller">—</span>
      </p>
      <p class="is-size-7">
        <span data-i18n="updated-label">Последнее обновление:</span> <span id="updated-at">—</span>
      </p>
      <p class="is-size-7">
        <span data-i18n="ledger-label">Ledger:</span> <span id="ledger">—</span>
      </p>
    </div>

    <!-- ERROR -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p data-i18n="error-title">Ошибка</p>
      </div>
      <div class="message-body" id="error-text">—</div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader" data-i18n="loader-text">Загрузка</progress>

    <!-- DETAILS -->
    <div class="box">
      <p class="title is-6" data-i18n="details-title">Детали</p>
      <div id="details" class="is-size-7">
        —
      </div>
    </div>

    <!-- RAW JSON -->
    <div class="box">
      <p class="title is-6" data-i18n="raw-json-title">Сырой JSON</p>
      <pre id="raw-json" class="is-size-7 is-mono">—</pre>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/common`;
    return '/common';
  })();
  const i18nBase = commonBase.replace(/common$/, 'i18n');
  document.getElementById('common-css').href = `${commonBase}.css?5`;
  const { shorten, isLocalLike } = await import(`${commonBase}.js?5`);
  const { initI18n } = await import(`${i18nBase}.js?5`);

  const horizonBase = 'https://horizon.stellar.org';
  const defaultOfferId = '1559224573';

  const statusEl = document.getElementById('status-label');
  const errorBox = document.getElementById('error-box');
  const errorText = document.getElementById('error-text');
  const loader = document.getElementById('loader');
  const langButtons = Array.from(document.querySelectorAll('#lang-switcher [data-lang]'));
  const i18n = await initI18n({ baseName: 'offer' });
  const { t } = i18n;

  let offerData = null;
  let statusState = 'loading';
  let lastErrorKey = '';
  let lastErrorDetail = '';
  let loaderVisible = false;
  let offerIdState = null;

  function setActiveLangButton(lang) {
    langButtons.forEach((btn) => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('is-primary', isActive);
      btn.classList.toggle('is-light', !isActive);
    });
  }

  function showLoading(on) {
    loader.textContent = t('loader-text');
    loaderVisible = on;
    loader.classList.toggle('is-hidden', !on);
  }

  function setStatus(state) {
    statusState = state;
    statusEl.classList.remove('is-danger', 'is-success', 'is-info');
    let key = 'status-loading';
    if (state === 'ok') {
      statusEl.classList.add('is-success');
      key = 'status-ok';
    } else if (state === 'error') {
      statusEl.classList.add('is-danger');
      key = 'status-error';
    } else {
      statusEl.classList.add('is-info');
    }
    statusEl.textContent = t(key);
  }

  function showError(messageKey, { detail = '' } = {}) {
    lastErrorKey = messageKey || '';
    lastErrorDetail = detail || '';
    const base = messageKey ? t(messageKey) : '';
    const msg = detail ? `${base ? base + ': ' : ''}${detail}` : base;
    errorText.textContent = msg || detail || '';
    errorBox.classList.remove('is-hidden');
    setStatus('error');
  }

  function clearError() {
    errorBox.classList.add('is-hidden');
  }

  function accountLink(acc, { short = true } = {}) {
    if (!acc) return '—';
    const label = short ? shorten(acc) : acc;
    return `<a class="is-mono" href="/account/${encodeURIComponent(acc)}" title="${acc}">${label}</a>`;
  }

  function assetLabel(asset) {
    if (!asset) return '—';
    if (asset.asset_type === 'native') return 'XLM';
    const code = asset.asset_code || '—';
    const issuer = asset.asset_issuer || '';
    const display = `${code} · ${issuer ? shorten(issuer) : '—'}`;
    const href = issuer ? `/assets/${encodeURIComponent(`${code}-${issuer}`)}` : null;
    return href ? `<a href="${href}">${display}</a>` : display;
  }

  function getOfferIdFromUrl() {
    const parts = window.location.pathname.split('/').filter(Boolean);
    if (parts.length >= 2 && parts[0] === 'offer') return parts[1];
    if (isLocalLike()) return defaultOfferId;
    return null;
  }

  async function loadOffer(offerId) {
    clearError();
    showLoading(true);
    try {
      const res = await fetch(`${horizonBase}/offers/${encodeURIComponent(offerId)}`);
      if (!res.ok) {
        let detail = `Horizon error ${res.status}`;
        try {
          const err = await res.json();
          if (err?.detail) detail = err.detail;
        } catch (_) {}
        throw new Error(detail);
      }
      const data = await res.json();

      setStatus('ok');
      offerData = data;

      document.getElementById('offer-id').textContent = data.id || offerId;
      document.getElementById('seller').innerHTML = accountLink(data.seller, { short: false });
      document.getElementById('updated-at').textContent = data.last_modified_time || '—';
      document.getElementById('ledger').textContent = data.last_modified_ledger || '—';

      const detailsEl = document.getElementById('details');
      const amount = data.amount || '—';
      const price = data.price || (data.price_r ? `${data.price_r.n}/${data.price_r.d}` : '—');
      detailsEl.innerHTML = `
        <div>${t('selling-label')}: ${assetLabel(data.selling)}</div>
        <div>${t('buying-label')}: ${assetLabel(data.buying)}</div>
        <div>${t('amount-label')}: <span class="has-text-weight-semibold">${amount}</span></div>
        <div>${t('price-label')}: ${price}</div>
      `;

      document.getElementById('raw-json').textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      console.error(e);
      showError('error-load-offer', { detail: e.message || t('error-unknown') });
    } finally {
      showLoading(false);
    }
  }

  const offerId = getOfferIdFromUrl();
  if (!offerId) {
    showError('error-no-offer-id');
  } else {
    offerIdState = offerId;
    loadOffer(offerId);
  }

  function reapplyLanguage() {
    if (offerIdState) document.getElementById('offer-id').textContent = offerIdState;
    if (offerData) {
      setStatus(statusState);
      document.getElementById('seller').innerHTML = accountLink(offerData.seller, { short: false });
      document.getElementById('updated-at').textContent = offerData.last_modified_time || '—';
      document.getElementById('ledger').textContent = offerData.last_modified_ledger || '—';
      const detailsEl = document.getElementById('details');
      const amount = offerData.amount || '—';
      const price = offerData.price || (offerData.price_r ? `${offerData.price_r.n}/${offerData.price_r.d}` : '—');
      detailsEl.innerHTML = `
        <div>${t('selling-label')}: ${assetLabel(offerData.selling)}</div>
        <div>${t('buying-label')}: ${assetLabel(offerData.buying)}</div>
        <div>${t('amount-label')}: <span class="has-text-weight-semibold">${amount}</span></div>
        <div>${t('price-label')}: ${price}</div>
      `;
      document.getElementById('raw-json').textContent = JSON.stringify(offerData, null, 2);
    }
    const errorVisible = !errorBox.classList.contains('is-hidden');
    if (errorVisible) {
      showError(lastErrorKey, { detail: lastErrorDetail });
    }
    showLoading(loaderVisible);
    setStatus(statusState);
    setActiveLangButton(i18n.lang());
  }

  setActiveLangButton(i18n.lang());

  langButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nextLang = btn.dataset.lang;
      await i18n.setLang(nextLang);
      reapplyLanguage();
    });
  });
</script>

</body>
</html>
