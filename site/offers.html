<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Account Offers</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css?2">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4 is-flex is-justify-content-space-between is-align-items-center">
      <a class="button is-small is-light" href="/" data-i18n="back-home">На главную</a>
      <div class="buttons are-small" id="lang-switcher">
        <button class="button is-light" data-lang="ru">RU</button>
        <button class="button is-light" data-lang="en">EN</button>
        <button class="button is-light" data-lang="es">ES</button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5" data-i18n="header-title">Офферы аккаунта</p>
            <p class="subtitle is-7" id="account-id">—</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label" data-i18n="status-loading">Loading…</span>
        </div>
      </div>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p data-i18n="error-title">Ошибка</p>
      </div>
      <div class="message-body" id="error-text">—</div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader" data-i18n="loader-text">Загрузка</progress>

    <!-- OFFERS LIST -->
    <div id="offers-container">
      <!-- cards go here -->
    </div>

    <div class="has-text-centered mt-4">
      <button class="button is-link is-light" id="btn-load-more" data-i18n="load-more">
        Загрузить ещё
      </button>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/common`;
    return '/common';
  })();
  const i18nBase = commonBase.replace(/common$/, 'i18n');
  document.getElementById('common-css').href = `${commonBase}.css?2`;
  const { shorten, isLocalLike } = await import(`${commonBase}.js?2`);
  const { initI18n } = await import(`${i18nBase}.js?2`);

  const horizonBase = 'https://horizon.stellar.org';
  const defaultAccountId = 'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V';
  const langButtons = Array.from(document.querySelectorAll('#lang-switcher [data-lang]'));
  const i18n = await initI18n({ baseName: 'offers' });
  const { t } = i18n;

  let offersState = [];
  let nextCursorState = null;
  let statusState = 'loading';
  let lastErrorKey = '';
  let lastErrorDetail = '';
  let accountIdState = null;
  let loadingVisible = false;

  function accountLink(acc) {
    return acc ? `/account/${encodeURIComponent(acc)}` : null;
  }

  function assetLabel(asset) {
    if (!asset) return '—';
    if (asset.asset_type === 'native') return 'XLM';
    const code = asset.asset_code || '—';
    const issuer = asset.asset_issuer || '';
    const text = `${code} · ${issuer ? shorten(issuer) : '—'}`;
    const href = issuer ? `/assets/${encodeURIComponent(`${code}-${issuer}`)}` : null;
    return href ? `<a href="${href}">${text}</a>` : text;
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.textContent = t('loader-text');
    loadingVisible = on;
    loader.classList.toggle('is-hidden', !on);
  }

  function showError(messageKey, { detail = '' } = {}) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    lastErrorKey = messageKey || '';
    lastErrorDetail = detail || '';
    const base = messageKey ? t(messageKey) : '';
    const msg = detail ? `${base ? base + ': ' : ''}${detail}` : base;
    text.textContent = msg || detail || '';
    box.classList.remove('is-hidden');
    setStatus('error');
  }

  function clearError() {
    document.getElementById('error-box').classList.add('is-hidden');
  }

  function setStatus(state) {
    statusState = state;
    const status = document.getElementById('status-label');
    status.classList.remove('is-danger', 'is-success', 'is-info');
    let key = 'status-loading';
    if (state === 'ok') {
      status.classList.add('is-success');
      key = 'status-ok';
    } else if (state === 'error') {
      status.classList.add('is-danger');
      key = 'status-error';
    } else {
      status.classList.add('is-info');
    }
    status.textContent = t(key);
  }

  function getAccountFromUrl() {
    const parts = window.location.pathname.split('/').filter(Boolean);
    if (parts.length >= 2 && parts[0] === 'offers') {
      return parts[1];
    }
    if (isLocalLike()) {
      return defaultAccountId;
    }
    return null;
  }

  async function fetchOffers(accountId, { cursor = null, limit = 50 } = {}) {
    const url = new URL(`${horizonBase}/accounts/${accountId}/offers`);
    url.searchParams.set('order', 'desc');
    url.searchParams.set('limit', limit);
    if (cursor) url.searchParams.set('cursor', cursor);

    const res = await fetch(url.toString());
    if (!res.ok) {
      throw new Error(`Horizon error ${res.status}`);
    }
    const data = await res.json();
    return data?._embedded?.records || [];
  }

  function renderOffers(list) {
    const container = document.getElementById('offers-container');
    container.innerHTML = '';

    if (!list.length) {
      container.innerHTML = `<p class="has-text-grey">${t('offers-empty')}</p>`;
      return;
    }

    list.forEach(offer => {
      const box = document.createElement('div');
      box.className = 'box is-size-7 offer-card';

      const price = offer.price || (offer.price_r ? `${offer.price_r.n}/${offer.price_r.d}` : '—');

      box.innerHTML = `
        <p class="mb-1">
          <strong><a href="/offer/${offer.id}">${t('offer-label')}${offer.id}</a></strong>
          · ${offer.last_modified_time || ''}
        </p>
        <p class="is-size-7">
          ${t('seller-label')}: ${accountLink(offer.seller) ? `<a class="is-mono" href="${accountLink(offer.seller)}">${shorten(offer.seller)}</a>` : '—'}
        </p>
        <p class="mt-2">${t('selling-label')}: ${assetLabel(offer.selling)}</p>
        <p>${t('buying-label')}: ${assetLabel(offer.buying)}</p>
        <p>${t('amount-label')}: <span class="has-text-weight-semibold">${offer.amount || '—'}</span></p>
        <p>${t('price-label')}: ${price}</p>
        <p class="is-size-7 has-text-grey">${t('ledger-label')}: ${offer.last_modified_ledger || '—'}</p>
      `;

      container.appendChild(box);
    });
  }

  async function main() {
    const accountId = getAccountFromUrl();
    const accountEl = document.getElementById('account-id');
    const loadMoreBtn = document.getElementById('btn-load-more');

    if (!accountId) {
      showError('error-no-account-id');
      return;
    }

    accountIdState = accountId;
    accountEl.textContent = accountId;

    let offers = [];
    let nextCursor = null;

    const loadBatch = async (opts = {}) => {
      clearError();
      showLoading(true);
      try {
        const batch = await fetchOffers(accountId, opts);
        if (opts.cursor) {
          offers = offers.concat(batch);
        } else {
          offers = batch;
        }
        nextCursor = batch.length ? batch[batch.length - 1].paging_token : null;
        offersState = offers;
        nextCursorState = nextCursor;
        renderOffers(offers);
        loadMoreBtn.disabled = !nextCursor;
        setStatus('ok');
      } catch (e) {
        console.error(e);
        showError('error-load-offers', { detail: e.message || t('error-unknown') });
      } finally {
        showLoading(false);
      }
    };

    loadMoreBtn.addEventListener('click', async () => {
      if (!nextCursor) {
        loadMoreBtn.disabled = true;
        return;
      }
      await loadBatch({ cursor: nextCursor, limit: 50 });
    });

    await loadBatch({ limit: 50 });
  }

  function setActiveLangButton(lang) {
    langButtons.forEach((btn) => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('is-primary', isActive);
      btn.classList.toggle('is-light', !isActive);
    });
  }

  function reapplyLanguage() {
    if (accountIdState) {
      document.getElementById('account-id').textContent = accountIdState;
    }
    renderOffers(offersState);
    const loadMoreBtn = document.getElementById('btn-load-more');
    if (loadMoreBtn) loadMoreBtn.disabled = !nextCursorState;
    const errorVisible = !document.getElementById('error-box').classList.contains('is-hidden');
    if (errorVisible) {
      showError(lastErrorKey, { detail: lastErrorDetail });
    }
    showLoading(loadingVisible);
    setStatus(statusState);
    setActiveLangButton(i18n.lang());
  }

  setActiveLangButton(i18n.lang());

  langButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nextLang = btn.dataset.lang;
      await i18n.setLang(nextLang);
      reapplyLanguage();
    });
  });

  main();
</script>

</body>
</html>
