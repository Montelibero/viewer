<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Stellar Account Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bulma через CDN -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">

  <style>
    body {
      background: #f5f5f5;
    }
    .account-address {
      word-break: break-all;
      font-size: 0.85rem;
    }
    .is-mono {
      font-family: monospace;
    }
    .section {
      padding-top: 1.5rem;
      padding-bottom: 2rem;
    }
    .bottom-actions {
      position: relative;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4">
      <a class="button is-small is-light" href="/">На главную</a>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5">Stellar Account</p>
            <p class="subtitle is-7" id="network-label">Mainnet</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label">Loading…</span>
        </div>
      </div>

      <p class="is-mono account-address" id="account-id">—</p>

      <div class="mt-2 buttons">
        <button class="button is-small is-light" id="copy-btn">
          Скопировать адрес
        </button>
        <a class="button is-small is-link is-light"
           id="btn-bsn"
           target="_blank"
           rel="noreferrer">
          BSN.expert
        </a>
        <a class="button is-small is-link is-light"
           id="btn-scopuly"
           target="_blank"
           rel="noreferrer">
          Scopuly
        </a>
        <a class="button is-small is-link is-light"
           id="btn-stellarchain"
           target="_blank"
           rel="noreferrer">
          StellarChain
        </a>
      </div>

      <div class="mt-3">
        <p class="is-size-7">
          Sequence: <span id="seq">—</span><br>
          Subentries: <span id="subentries">—</span>
        </p>
      </div>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p>Ошибка</p>
      </div>
      <div class="message-body" id="error-text">
        —
      </div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader">Загрузка</progress>

    <!-- BALANCES -->
    <div class="box">
      <p class="title is-6">Балансы</p>

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Ассеты</p>
      <ul id="balances-assets" class="is-size-7 mb-3">
        <!-- сюда пойдут ассеты -->
      </ul>

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Пулы</p>
      <ul id="balances-pools" class="is-size-7 mb-3">
        <!-- сюда пойдут пуллы -->
      </ul>

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Выпущенные ассеты</p>
      <ul id="balances-issued" class="is-size-7">
        <!-- сюда пойдут выпущенные ассеты -->
      </ul>
    </div>

    <!-- SIGNERS -->
    <div class="box">
      <p class="title is-6">Подписанты и пороги</p>
      <p class="is-size-7">
        Пороги:
        <span id="thresholds">—</span>
      </p>
      <ul id="signers" class="is-size-7 mt-2">
        <!-- сюда пойдут подписанты -->
      </ul>
    </div>

    <!-- DATA -->
    <div class="box">
      <p class="title is-6">Data</p>
      <ul id="data" class="is-size-7">
        <!-- сюда пойдут data-поля -->
      </ul>
    </div>

    <!-- BOTTOM ACTIONS -->
    <div class="bottom-actions">
      <div class="buttons">
        <a class="button is-link is-light is-fullwidth"
           id="btn-operations">
          Операции
        </a>
      </div>
    </div>

  </div>
</section>

<script type="module">
  const horizonBase = 'https://horizon.stellar.org'; // на будущее можно сделать переключатель сети

  function getAccountIdFromUrl() {
    const path = window.location.pathname; // /account/GD...
    const parts = path.split('/').filter(Boolean); // ['account', 'GD...']
    if (parts.length >= 2 && parts[0] === 'account') {
      return parts[1];
    }
    return null;
  }

  function shorten(str) {
    if (!str || str.length <= 12) return str;
    return str.slice(0, 4) + '…' + str.slice(-4);
  }

  function formatAssetLabel(asset) {
    if (!asset || asset === 'native') {
      return { text: 'XLM', href: null };
    }
    const [code, issuer] = asset.split(':');
    const text = `${code || '—'} · ${issuer ? shorten(issuer) : '—'}`;
    const href = code && issuer
      ? `/assets/${encodeURIComponent(`${code}-${issuer}`)}`
      : null;
    return { text, href };
  }

  function accountLink(acc) {
    return acc ? `/account/${encodeURIComponent(acc)}` : null;
  }

  const poolMetaCache = new Map();

  async function describePool(poolId, linkEl, subtitleEl) {
    if (poolMetaCache.has(poolId)) {
      const label = poolMetaCache.get(poolId);
      if (label) linkEl.textContent = `Пул: ${label}`;
      return;
    }
    try {
      const res = await fetch(`${horizonBase}/liquidity_pools/${poolId}`);
      if (!res.ok) throw new Error('load failed');
      const data = await res.json();
      const reserves = data?.reserves || [];
      const labels = reserves.map(r => formatAssetLabel(r.asset).text).filter(Boolean);
      const label = labels.length ? labels.join(' / ') : shorten(poolId);
      poolMetaCache.set(poolId, label);
      linkEl.textContent = `Пул: ${label}`;
      if (subtitleEl) {
        subtitleEl.textContent = `ID: ${shorten(poolId)}`;
      }
    } catch (e) {
      poolMetaCache.set(poolId, null);
    }
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.classList.toggle('is-hidden', !on);
  }

  function showError(message) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    text.textContent = message;
    box.classList.remove('is-hidden');
    const status = document.getElementById('status-label');
    status.textContent = 'Error';
    status.classList.remove('is-info');
    status.classList.add('is-danger');
  }

  function clearError() {
    const box = document.getElementById('error-box');
    box.classList.add('is-hidden');
  }

  function renderBalances(account) {
    const assetsEl = document.getElementById('balances-assets');
    const poolsEl = document.getElementById('balances-pools');

    assetsEl.innerHTML = '';
    poolsEl.innerHTML = '';

    const balances = account.balances || [];
    const assets = balances.filter(b => b.asset_type !== 'liquidity_pool_shares');
    const pools = balances.filter(b => b.asset_type === 'liquidity_pool_shares');

    if (!assets.length) {
      assetsEl.textContent = 'Нет ассетов.';
    } else {
      assets.forEach(b => {
        const li = document.createElement('li');
        li.className = 'mb-2';

        let code = '';
        if (b.asset_type === 'native') {
          code = 'XLM';
        } else {
          const issuerShort = b.asset_issuer ? shorten(b.asset_issuer) : '—';
          code = `${b.asset_code || '—'} · ${issuerShort}`;
        }

        const title = document.createElement('div');
        if (b.asset_type === 'native') {
          title.textContent = code;
        } else {
          if (b.asset_code && b.asset_issuer) {
            const link = document.createElement('a');
            link.href = `/assets/${encodeURIComponent(`${b.asset_code}-${b.asset_issuer}`)}`;
            link.textContent = code;
            link.className = 'has-text-weight-semibold';
            title.appendChild(link);
          } else {
            title.textContent = code;
          }
        }

        const amount = document.createElement('div');
        amount.innerHTML = `balance: <span class="has-text-weight-semibold">${b.balance}</span>`;
        if (b.limit) {
          amount.innerHTML += `<br><span>limit: ${b.limit}</span>`;
        }

        li.appendChild(title);
        li.appendChild(amount);
        assetsEl.appendChild(li);
      });
    }

    if (!pools.length) {
      poolsEl.textContent = 'Нет пуллов.';
    } else {
      pools.forEach(b => {
        const li = document.createElement('li');
        li.className = 'mb-2';

        const link = document.createElement('a');
        link.href = `/pool/${encodeURIComponent(b.liquidity_pool_id)}`;
        link.textContent = `Пул ${shorten(b.liquidity_pool_id)}`;
        link.className = 'has-text-weight-semibold';

        const subtitle = document.createElement('div');
        subtitle.className = 'is-size-7';
        subtitle.textContent = `ID: ${shorten(b.liquidity_pool_id)}`;

        describePool(b.liquidity_pool_id, link, subtitle);

        const amount = document.createElement('div');
        amount.innerHTML = `balance: <span class="has-text-weight-semibold">${b.balance}</span>`;
        if (b.limit) {
          amount.innerHTML += `<br><span>limit: ${b.limit}</span>`;
        }

        li.appendChild(link);
        li.appendChild(subtitle);
        li.appendChild(amount);
        poolsEl.appendChild(li);
      });
    }
  }

  async function loadIssuedAssets(issuer) {
    const issuedEl = document.getElementById('balances-issued');
    issuedEl.textContent = 'Загрузка…';
    try {
      const res = await fetch(`${horizonBase}/assets?asset_issuer=${encodeURIComponent(issuer)}&limit=200`);
      if (!res.ok) {
        throw new Error(`Horizon error ${res.status}`);
      }
      const data = await res.json();
      const records = data?._embedded?.records || [];
      issuedEl.innerHTML = '';

      if (!records.length) {
        issuedEl.textContent = 'Нет выпущенных ассетов.';
        return;
      }

      records.forEach(asset => {
        const li = document.createElement('li');
        li.className = 'mb-2';

        const link = document.createElement('a');
        const id = `${asset.asset_code}-${asset.asset_issuer}`;
        link.href = `/assets/${encodeURIComponent(id)}`;
        link.textContent = id;
        link.className = 'has-text-weight-semibold';

        const amount = document.createElement('div');
        amount.innerHTML = `supply: <span class="has-text-weight-semibold">${asset.amount}</span>`;
        if (typeof asset.num_accounts !== 'undefined') {
          amount.innerHTML += `<br><span>holders: ${asset.num_accounts}</span>`;
        }

        li.appendChild(link);
        li.appendChild(amount);
        issuedEl.appendChild(li);
      });
    } catch (e) {
      issuedEl.textContent = 'Не удалось загрузить выпущенные ассеты.';
      console.error(e);
    }
  }

  function renderAccount(account) {
    // Header
    document.getElementById('seq').textContent = account.sequence;
    document.getElementById('subentries').textContent = account.subentry_count;
    document.getElementById('status-label').textContent = 'OK';
    document.getElementById('status-label').classList.remove('is-danger');
    document.getElementById('status-label').classList.add('is-success');

    // Thresholds
    const th = account.thresholds || {};
    document.getElementById('thresholds').textContent =
      `low=${th.low_threshold}, med=${th.med_threshold}, high=${th.high_threshold}`;

    // Balances
    renderBalances(account);

    // Signers
    const signersEl = document.getElementById('signers');
    signersEl.innerHTML = '';
    account.signers.forEach(s => {
      const li = document.createElement('li');
      li.className = 'mb-1';

      const link = accountLink(s.key);
      const keyLabel = shorten(s.key);

      li.innerHTML = `
        <span>${s.type}</span><br>
        ${link
          ? `<a class="is-mono is-size-7" href="${link}" title="${s.key}">${keyLabel}</a>`
          : `<code class="is-mono is-size-7">${s.key}</code>`}<br>
        <span>weight: ${s.weight}</span>
      `;
      signersEl.appendChild(li);
    });
    if (!account.signers.length) {
      signersEl.textContent = 'Нет подписантов.';
    }

    // Data
    const dataEl = document.getElementById('data');
    dataEl.innerHTML = '';
    const dataAttr = account.data_attr || account.data || {};
    const entries = Object.entries(dataAttr);
    if (!entries.length) {
      dataEl.textContent = 'Нет data-полей.';
    } else {
      entries.forEach(([key, value]) => {
        const li = document.createElement('li');
        li.className = 'mb-1';

        const title = document.createElement('strong');
        title.textContent = key;
        li.appendChild(title);
        li.appendChild(document.createElement('br'));

        let decoded = '';
        try {
          decoded = atob(value);
        } catch (e) {
          decoded = '[не удалось декодировать base64]';
        }

        const isAccountId = /^G[A-Z2-7]{55}$/.test(decoded);
        let displayText = decoded;
        if (!isAccountId && decoded.length > 120) {
          displayText = decoded.slice(0, 120) + '…';
        }

        if (isAccountId) {
          const link = document.createElement('a');
          link.href = `/account/${encodeURIComponent(decoded)}`;
          link.textContent = decoded;
          link.className = 'is-size-7 is-mono';
          li.appendChild(link);
        } else {
          const codeEl = document.createElement('code');
          codeEl.className = 'is-mono is-size-7';
          codeEl.textContent = displayText;
          li.appendChild(codeEl);
        }

        dataEl.appendChild(li);
      });
    }

    // Внешние ссылки
    const id = account.id;
    document.getElementById('btn-bsn').href =
      `https://bsn.expert/accounts/${id}`;
    document.getElementById('btn-scopuly').href =
      `https://scopuly.com/account/${id}`;
    document.getElementById('btn-stellarchain').href =
      `https://stellarchain.io/accounts/${id}`;
    document.getElementById('btn-operations').href =
      `/operations/${encodeURIComponent(id)}`;

    // Issued assets
    loadIssuedAssets(account.id);
  }

  async function loadAccount() {
    const accountId = getAccountIdFromUrl();
    const accountEl = document.getElementById('account-id');

    if (!accountId) {
      showError('Не удалось определить accountId из URL.');
      return;
    }

    accountEl.textContent = accountId;
    clearError();
    showLoading(true);

    try {
      const res = await fetch(`${horizonBase}/accounts/${accountId}`);
      if (!res.ok) {
        let detail = `Horizon error ${res.status}`;
        try {
          const err = await res.json();
          if (err?.detail) detail = err.detail;
        } catch (_) {
          // ignore
        }
        throw new Error(detail);
      }
      const data = await res.json();
      renderAccount(data);
    } catch (e) {
      console.error(e);
      showError(e.message || 'Неизвестная ошибка при загрузке аккаунта.');
    } finally {
      showLoading(false);
    }
  }

  // Кнопка "копировать"
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const text = document.getElementById('account-id').textContent;
    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-btn');
      const old = btn.textContent;
      btn.textContent = 'Скопировано';
      setTimeout(() => (btn.textContent = old), 1500);
    } catch (e) {
      alert('Не удалось скопировать в буфер обмена.');
    }
  });

  // старт
  loadAccount();
</script>

</body>
</html>
