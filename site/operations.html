<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Account Operations</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4 is-flex is-justify-content-space-between is-align-items-center">
      <a class="button is-small is-light" href="/" data-i18n="back-home">На главную</a>
      <div class="buttons are-small" id="lang-switcher">
        <button class="button is-light" data-lang="ru">RU</button>
        <button class="button is-light" data-lang="en">EN</button>
        <button class="button is-light" data-lang="es">ES</button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5" data-i18n="header-title">Операции аккаунта</p>
            <p class="subtitle is-7" id="account-id">—</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label" data-i18n="status-loading">Loading…</span>
        </div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="box">
      <p class="title is-6" data-i18n="filters-title">Фильтры</p>
      <div class="columns is-multiline is-mobile">
        <div class="column is-12-mobile is-4-tablet">
          <label class="label is-size-7" data-i18n="filter-amount-label">Сумма (25, >25, <1000)</label>
          <input class="input is-small"
                 type="text"
                 id="filter-amount"
                 data-i18n-placeholder="filter-amount-placeholder"
                 placeholder="например >25">
        </div>
        <div class="column is-12-mobile is-4-tablet">
          <label class="label is-size-7" data-i18n="filter-asset-label">Актив (код)</label>
          <input class="input is-small"
                 type="text"
                 id="filter-asset"
                 data-i18n-placeholder="filter-asset-placeholder"
                 placeholder="USDM">
        </div>
        <div class="column is-12-mobile is-4-tablet">
          <label class="label is-size-7" data-i18n="filter-type-label">Тип (+payment, -data, +payment -data)</label>
          <input class="input is-small"
                 type="text"
                 id="filter-type"
                 data-i18n-placeholder="filter-type-placeholder"
                 placeholder="+payment -data">
        </div>
      </div>
      <p class="help is-danger is-hidden" id="filter-error"></p>
      <div class="buttons mt-2">
        <button class="button is-primary is-small" id="btn-apply-filter" data-i18n="btn-apply-filter">
          Фильтр (загрузить 200)
        </button>
        <button class="button is-light is-small" id="btn-clear-filter" data-i18n="btn-clear-filter">
          Сбросить
        </button>
      </div>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p data-i18n="error-title">Ошибка</p>
      </div>
      <div class="message-body" id="error-text">—</div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader" data-i18n="loader-text">Загрузка</progress>

    <!-- OPERATIONS LIST -->
    <div id="operations-container">
      <!-- cards -->
    </div>

    <div class="has-text-centered mt-4">
      <div class="buttons is-centered">
        <button class="button is-link is-light" id="btn-load-more" data-i18n="load-more">
          Загрузить ещё
        </button>
        <button class="button is-info is-light" id="btn-export-csv" data-i18n="export-csv">
          Экспорт в CSV
        </button>
      </div>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
  const m = window.location.pathname.match(/^(.*\/site)\//);
  if (m) return `${m[1]}/common`;
  return '/common';
  })();
  document.getElementById('common-css').href = `${commonBase}.css`;
  const i18nBase = commonBase.replace(/common$/, 'i18n');
  const moduleBase = (() => {
    if (window.location.protocol === 'file:') return './';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/`;
    return '/';
  })();
  const { isLocalLike } = await import(`${commonBase}.js`);
  const {
    assetLabelFull,
    createOperationCard
  } = await import(`${moduleBase}operation-view.js`);
  const { initI18n } = await import(`${i18nBase}.js`);

  const horizonBase = 'https://horizon.stellar.org';
  const defaultAccountId = 'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V';
  const langButtons = Array.from(document.querySelectorAll('#lang-switcher [data-lang]'));
  const i18n = await initI18n({ baseName: 'operations' });
  const { t } = i18n;

  function getAccountFromUrl() {
    const parts = window.location.pathname.split('/').filter(Boolean);
    if (parts.length >= 2 && parts[0] === 'operations') {
      return parts[1];
    }
    if (isLocalLike()) {
      return defaultAccountId;
    }
    return null;
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.textContent = t('loader-text');
    loader.classList.toggle('is-hidden', !on);
  }

  let operationsState = [];
  let nextCursorState = null;
  let statusState = 'loading';
  let lastErrorKey = '';
  let lastErrorDetail = '';
  let accountIdState = null;
  let filterErrorState = '';
  let filterErrorKey = '';

  function setStatus(state) {
    statusState = state;
    const status = document.getElementById('status-label');
    status.classList.remove('is-danger', 'is-success', 'is-info');
    let key = 'status-loading';
    if (state === 'ok') {
      status.classList.add('is-success');
      key = 'status-ok';
    } else if (state === 'error') {
      status.classList.add('is-danger');
      key = 'status-error';
    } else {
      status.classList.add('is-info');
    }
    status.textContent = t(key);
  }

  function showError(messageKey, { detail = '' } = {}) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    lastErrorKey = messageKey || '';
    lastErrorDetail = detail || '';
    const base = messageKey ? t(messageKey) : '';
    const msg = detail ? `${base ? base + ': ' : ''}${detail}` : base;
    text.textContent = msg || detail || '';
    box.classList.remove('is-hidden');
    setStatus('error');
  }

  function clearError() {
    document.getElementById('error-box').classList.add('is-hidden');
  }

  function parseAmountFilter(value) {
    if (!value.trim()) return null;
    const re = /^([<>])?\s*(\d+(?:\.\d+)?)$/;
    const m = value.trim().match(re);
    if (!m) return { error: t('filter-amount-error') };
    return { op: m[1] || '=', value: parseFloat(m[2]) };
  }

  function matchesAmount(op, filter) {
    if (!filter) return true;
    let matched = false;
    const visit = (obj) => {
      if (!obj || typeof obj !== 'object') return;
      Object.entries(obj).forEach(([key, val]) => {
        if (typeof val === 'object') {
          visit(val);
          return;
        }
        if (typeof val !== 'string') return;
        if (!/(amount|balance|limit|price|reserve)/i.test(key)) return;
        if (!/^\d+(?:\.\d+)?$/.test(val)) return;
        const num = parseFloat(val);
        if (filter.op === '>' && num > filter.value) matched = true;
        else if (filter.op === '<' && num < filter.value) matched = true;
        else if (filter.op === '=' && num === filter.value) matched = true;
      });
    };
    visit(op);
    return matched;
  }

  function matchesAsset(op, assetCode) {
    if (!assetCode) return true;
    const needle = assetCode.trim().toUpperCase();
    let found = false;
    const visit = (obj) => {
      if (!obj || typeof obj !== 'object') return;
      Object.entries(obj).forEach(([key, val]) => {
        if (typeof val === 'object') {
          visit(val);
          return;
        }
        if (typeof val !== 'string') return;
        if (!/(asset|selling|buying)/i.test(key)) return;
        const upper = val.toUpperCase();
        if (upper.includes(needle)) found = true;
      });
    };
    visit(op);
    return found;
  }

  function matchesType(op, typeTokens) {
    if (!typeTokens || !typeTokens.length) return true;
    const opType = (op.type || '').toLowerCase();
    const plus = typeTokens.filter(t => t.startsWith('+')).map(t => t.slice(1).toLowerCase()).filter(Boolean);
    const minus = typeTokens.filter(t => t.startsWith('-')).map(t => t.slice(1).toLowerCase()).filter(Boolean);

    if (plus.length && !plus.some(t => opType.includes(t))) return false;
    if (minus.length && minus.some(t => opType.includes(t))) return false;
    return true;
  }

  function applyFilters(list, filters) {
    return list.filter(op =>
      matchesAmount(op, filters.amount) &&
      matchesAsset(op, filters.asset) &&
      matchesType(op, filters.types)
    );
  }

  function renderOperations(list) {
    const container = document.getElementById('operations-container');
    container.innerHTML = '';

    if (!list.length) {
      container.innerHTML = `<p class="has-text-grey">${t('ops-empty')}</p>`;
      return;
    }

    list.forEach(op => {
      const box = createOperationCard(op);
      container.appendChild(box);
    });
  }

  function parseTypeTokens(raw) {
    if (!raw.trim()) return [];
    return raw.trim().split(/\s+/).filter(Boolean);
  }

  async function fetchOperations(accountId, { cursor = null, limit = 50 } = {}) {
    const url = new URL(`${horizonBase}/accounts/${accountId}/operations`);
    url.searchParams.set('order', 'desc');
    url.searchParams.set('limit', limit);
    url.searchParams.set('include_failed', 'true');
    if (cursor) url.searchParams.set('cursor', cursor);

    const res = await fetch(url.toString());
    if (!res.ok) {
      throw new Error(`Horizon error ${res.status}`);
    }
    const data = await res.json();
    return data?._embedded?.records || [];
  }

  async function main() {
    const accountId = getAccountFromUrl();
    const accountEl = document.getElementById('account-id');
    const filterErrorEl = document.getElementById('filter-error');
    const loadMoreBtn = document.getElementById('btn-load-more');

    if (!accountId) {
      showError('error-no-account');
      return;
    }

    accountIdState = accountId;
    accountEl.textContent = accountId;

    let operations = [];
    let nextCursor = null;

    const applyAndRender = (opts = {}) => {
      const amountFilter = parseAmountFilter(document.getElementById('filter-amount').value);
      if (amountFilter?.error) {
        filterErrorEl.textContent = amountFilter.error;
        filterErrorEl.classList.remove('is-hidden');
        filterErrorState = filterErrorEl.textContent;
        filterErrorKey = 'filter-amount-error';
        return;
      }
      filterErrorEl.classList.add('is-hidden');
      filterErrorState = '';
      filterErrorKey = '';

      const filters = {
        amount: amountFilter,
        asset: document.getElementById('filter-asset').value.trim().toUpperCase() || null,
        types: parseTypeTokens(document.getElementById('filter-type').value)
      };
      const list = applyFilters(operations, filters);
      renderOperations(list);
      if (opts.resetCursor !== undefined) {
        loadMoreBtn.disabled = !nextCursor;
      }
    };

    const applyFilterAndReload = async () => {
      const amountFilter = parseAmountFilter(document.getElementById('filter-amount').value);
      if (amountFilter?.error) {
        filterErrorEl.textContent = amountFilter.error;
        filterErrorEl.classList.remove('is-hidden');
        filterErrorState = filterErrorEl.textContent;
        filterErrorKey = 'filter-amount-error';
        return;
      }
      filterErrorEl.classList.add('is-hidden');
      filterErrorState = '';
      filterErrorKey = '';
      showLoading(true);
      try {
        const batch = await fetchOperations(accountId, { limit: 200 });
        operations = batch;
        nextCursor = batch.length ? batch[batch.length - 1].paging_token : null;
        operationsState = operations;
        nextCursorState = nextCursor;
        applyAndRender();
        loadMoreBtn.disabled = !nextCursor;
      } catch (e) {
        console.error(e);
        showError('error-apply-filter', { detail: e.message || t('error-unknown') });
      } finally {
        showLoading(false);
      }
    };

    const loadInitial = async () => {
      clearError();
      showLoading(true);
      try {
        const batch = await fetchOperations(accountId, { limit: 50 });
        operations = batch;
        nextCursor = batch.length ? batch[batch.length - 1].paging_token : null;
        operationsState = operations;
        nextCursorState = nextCursor;
        setStatus('ok');
        renderOperations(operations);
        loadMoreBtn.disabled = !nextCursor;
      } catch (e) {
        console.error(e);
        showError('error-load-ops', { detail: e.message || t('error-unknown') });
      } finally {
        showLoading(false);
      }
    };

    loadMoreBtn.addEventListener('click', async () => {
      if (!nextCursor) {
        loadMoreBtn.disabled = true;
        return;
      }
      showLoading(true);
      try {
        const batch = await fetchOperations(accountId, { cursor: nextCursor, limit: 50 });
        if (!batch.length) {
          nextCursor = null;
          loadMoreBtn.disabled = true;
        } else {
          operations = operations.concat(batch);
          nextCursor = batch[batch.length - 1].paging_token;
          operationsState = operations;
          nextCursorState = nextCursor;
          applyAndRender();
        }
      } catch (e) {
        console.error(e);
        showError('error-load-more', { detail: e.message || t('error-unknown') });
      } finally {
        showLoading(false);
      }
    });

    document.getElementById('btn-apply-filter').addEventListener('click', applyFilterAndReload);

    document.getElementById('btn-clear-filter').addEventListener('click', () => {
      document.getElementById('filter-amount').value = '';
      document.getElementById('filter-asset').value = '';
      document.getElementById('filter-type').value = '';
      applyAndRender();
    });

    ['filter-amount', 'filter-asset', 'filter-type'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyFilterAndReload();
        }
      });
    });

    await loadInitial();

    function exportToCsv(list, accountId) {
      // Keep CSV headers in English for consistency across exports
      const header = 'Transaction hash,Date,Operation,From,Token,Amount,To,Token 2,Amount 2,Successful';
      const rows = list.map(op => {
        let from = op.source_account || '';
        let to = '',
          token1 = '', amount1 = '',
          token2 = '', amount2 = '';

        if (op.type === 'payment' || op.type === 'path_payment_strict_receive' || op.type === 'path_payment_strict_send') {
          from = op.from || from;
          to = op.to || '';
          token1 = assetLabelFull(op.asset_code || op.asset_type, op.asset_issuer);
          amount1 = op.amount || '';
        } else if (op.type === 'create_account') {
          to = op.account || '';
          token1 = 'XLM';
          amount1 = op.starting_balance || '';
        } else if (op.type === 'manage_sell_offer' || op.type === 'manage_buy_offer' || op.type === 'create_passive_sell_offer') {
          token1 = assetLabelFull(op.selling_asset_code || op.selling_asset_type, op.selling_asset_issuer);
          amount1 = op.amount || '';
          token2 = assetLabelFull(op.buying_asset_code || op.buying_asset_type, op.buying_asset_issuer);
          amount2 = op.price ? (parseFloat(op.amount) * parseFloat(op.price)).toFixed(7) : '';
        }

        const fields = [
          op.transaction_hash || '',
          op.created_at || '',
          op.type || '',
          from,
          token1,
          amount1,
          to,
          token2,
          amount2,
          op.transaction_successful,
        ];
        return fields.map(field => `"${String(field ?? '').replace(/"/g, '""')}"`).join(',');
      });

      const csv = [header, ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `${accountId}_operations.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById('btn-export-csv').addEventListener('click', () => {
      const filters = {
        amount: parseAmountFilter(document.getElementById('filter-amount').value),
        asset: document.getElementById('filter-asset').value.trim().toUpperCase() || null,
        types: parseTypeTokens(document.getElementById('filter-type').value)
      };
      const list = applyFilters(operations, filters);
      exportToCsv(list, accountId);
    });
  }

  function setActiveLangButton(lang) {
    langButtons.forEach((btn) => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('is-primary', isActive);
      btn.classList.toggle('is-light', !isActive);
    });
  }

  function reapplyLanguage() {
    if (accountIdState) document.getElementById('account-id').textContent = accountIdState;
    const filterErrorEl = document.getElementById('filter-error');
    if (filterErrorState) {
      filterErrorEl.textContent = filterErrorKey ? t(filterErrorKey) : filterErrorState;
      filterErrorEl.classList.remove('is-hidden');
    } else {
      filterErrorEl.classList.add('is-hidden');
    }
    renderOperations(operationsState);
    const loadMoreBtn = document.getElementById('btn-load-more');
    if (loadMoreBtn) loadMoreBtn.disabled = !nextCursorState;
    const errorVisible = !document.getElementById('error-box').classList.contains('is-hidden');
    if (errorVisible) {
      showError(lastErrorKey, { detail: lastErrorDetail });
    }
    showLoading(!document.getElementById('loader').classList.contains('is-hidden'));
    setStatus(statusState);
    setActiveLangButton(i18n.lang());
  }

  setActiveLangButton(i18n.lang());

  langButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nextLang = btn.dataset.lang;
      await i18n.setLang(nextLang);
      reapplyLanguage();
    });
  });

  main();
</script>

</body>
</html>
