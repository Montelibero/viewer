<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Operation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4 is-flex is-justify-content-space-between is-align-items-center">
      <a class="button is-small is-light" href="/" data-i18n="back-home">На главную</a>
      <div class="buttons are-small" id="lang-switcher">
        <button class="button is-light" data-lang="ru">RU</button>
        <button class="button is-light" data-lang="en">EN</button>
        <button class="button is-light" data-lang="es">ES</button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="box" id="op-header-box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5" data-i18n="header-title">Операция</p>
            <p class="subtitle is-7" id="op-type">—</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label" data-i18n="status-loading">Loading…</span>
        </div>
      </div>

      <p class="is-mono is-size-7" id="op-id">—</p>
      <p class="is-size-7" id="op-created">—</p>
      <p class="is-size-7"><span data-i18n="source-label">Источник:</span> <span id="op-source">—</span></p>
      <p class="is-size-7"><span data-i18n="tx-label">Транзакция:</span> <span id="op-tx">—</span></p>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p data-i18n="error-title">Ошибка</p>
      </div>
      <div class="message-body" id="error-text">—</div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader" data-i18n="loader-text">Загрузка</progress>

    <!-- DETAILS -->
    <div class="box" id="op-details-box">
      <p class="title is-6" data-i18n="details-title">Детали</p>
      <div id="op-details" class="is-size-7"></div>
    </div>

    <!-- RAW JSON -->
    <div class="box" id="op-json-box">
      <p class="title is-6" data-i18n="json-title">JSON</p>
      <pre id="op-json" class="is-size-7"></pre>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/common`;
    return '/common';
  })();
  document.getElementById('common-css').href = `${commonBase}.css`;
  const i18nBase = commonBase.replace(/common$/, 'i18n');
  const moduleBase = (() => {
    if (window.location.protocol === 'file:') return './';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/`;
    return '/';
  })();
  const { shorten, isLocalLike } = await import(`${commonBase}.js`);
  const { accountLink, renderOperationDetails } = await import(`${moduleBase}operation-view.js`);
  const { initI18n } = await import(`${i18nBase}.js`);

  const horizonBase = 'https://horizon.stellar.org';
  const defaultOpId = '257949658419138561';
  const langButtons = Array.from(document.querySelectorAll('#lang-switcher [data-lang]'));
  const i18n = await initI18n({ baseName: 'operation' });
  const { t } = i18n;

  let opData = null;
  let statusState = 'loading';
  let lastErrorKey = '';
  let lastErrorDetail = '';
  let loaderVisible = false;
  let currentOpId = null;

  function getOpIdFromUrl() {
    const parts = window.location.pathname.split('/').filter(Boolean);
    if (parts.length >= 2 && parts[0] === 'operation') {
      return parts[1];
    }
    if (isLocalLike()) {
      return defaultOpId;
    }
    return null;
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.textContent = t('loader-text');
    loaderVisible = on;
    loader.classList.toggle('is-hidden', !on);
  }

  function setStatus(state) {
    statusState = state;
    const status = document.getElementById('status-label');
    status.classList.remove('is-danger', 'is-success', 'is-info');
    let key = 'status-loading';
    if (state === 'success') {
      status.classList.add('is-success');
      key = 'status-success';
    } else if (state === 'failed') {
      status.classList.add('is-danger');
      key = 'status-failed';
    } else if (state === 'error') {
      status.classList.add('is-danger');
      key = 'status-error';
    } else {
      status.classList.add('is-info');
    }
    status.textContent = t(key);
  }

  function showError(messageKey, { detail = '' } = {}) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    lastErrorKey = messageKey || '';
    lastErrorDetail = detail || '';
    const base = messageKey ? t(messageKey) : '';
    const msg = detail ? `${base ? base + ': ' : ''}${detail}` : base;
    text.textContent = msg || detail || '';
    box.classList.remove('is-hidden');
    setStatus('error');
  }

  function clearError() {
    document.getElementById('error-box').classList.add('is-hidden');
  }

  async function loadOp() {
    const opId = getOpIdFromUrl();
    if (!opId) {
      showError('error-no-op-id');
      return;
    }

    currentOpId = opId;
    clearError();
    setStatus('loading');
    showLoading(true);

    try {
      const res = await fetch(`${horizonBase}/operations/${opId}`);
      if (!res.ok) {
        throw new Error(`Horizon error ${res.status}`);
      }
      const op = await res.json();
      opData = op;

      document.getElementById('op-id').textContent = op.id || opId;
      document.getElementById('op-type').textContent = op.type || '—';
      document.getElementById('op-created').textContent = op.created_at || '';

      const srcLink = accountLink(op.source_account);
      document.getElementById('op-source').innerHTML =
        srcLink ? `<a class="is-mono" href="${srcLink}">${shorten(op.source_account)}</a>` : (op.source_account || '—');

      const txLink = op.transaction_hash ? `/transaction/${op.transaction_hash}` : null;
      document.getElementById('op-tx').innerHTML =
        txLink ? `<a class="is-mono" href="${txLink}">${shorten(op.transaction_hash)}</a>` : '—';

      const details = document.getElementById('op-details');
      details.innerHTML = '';
      details.appendChild(renderOperationDetails(op));
      document.getElementById('op-json').textContent = JSON.stringify(op, null, 2);

      const status = document.getElementById('status-label');
      const headerBox = document.getElementById('op-header-box');
      if (op.transaction_successful) {
        setStatus('success');
        headerBox.classList.remove('is-failed');
      } else {
        setStatus('failed');
        headerBox.classList.add('is-failed');
      }
    } catch (e) {
      console.error(e);
      showError('error-load-op', { detail: e.message || t('error-unknown') });
    } finally {
      showLoading(false);
    }
  }

  loadOp();

  function setActiveLangButton(lang) {
    langButtons.forEach((btn) => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('is-primary', isActive);
      btn.classList.toggle('is-light', !isActive);
    });
  }

  function reapplyLanguage() {
    if (currentOpId) document.getElementById('op-id').textContent = currentOpId;
    if (opData) {
      document.getElementById('op-type').textContent = opData.type || '—';
      document.getElementById('op-created').textContent = opData.created_at || '';

      const srcLink = accountLink(opData.source_account);
      document.getElementById('op-source').innerHTML =
        srcLink ? `<a class="is-mono" href="${srcLink}">${shorten(opData.source_account)}</a>` : (opData.source_account || '—');

      const txLink = opData.transaction_hash ? `/transaction/${opData.transaction_hash}` : null;
      document.getElementById('op-tx').innerHTML =
        txLink ? `<a class="is-mono" href="${txLink}">${shorten(opData.transaction_hash)}</a>` : '—';

      const details = document.getElementById('op-details');
      details.innerHTML = '';
      details.appendChild(renderOperationDetails(opData));
      document.getElementById('op-json').textContent = JSON.stringify(opData, null, 2);

      const headerBox = document.getElementById('op-header-box');
      if (opData.transaction_successful) {
        setStatus('success');
        headerBox.classList.remove('is-failed');
      } else {
        setStatus('failed');
        headerBox.classList.add('is-failed');
      }
    }
    const errorVisible = !document.getElementById('error-box').classList.contains('is-hidden');
    if (errorVisible) {
      showError(lastErrorKey, { detail: lastErrorDetail });
    }
    showLoading(loaderVisible);
    setActiveLangButton(i18n.lang());
  }

  setActiveLangButton(i18n.lang());

  langButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nextLang = btn.dataset.lang;
      await i18n.setLang(nextLang);
      reapplyLanguage();
    });
  });
</script>

</body>
</html>
