<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Stellar Account Viewer</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bulma через CDN -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css?5">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4 is-flex is-justify-content-space-between is-align-items-center">
      <a class="button is-small is-light" href="/" data-i18n="back-home">На главную</a>
      <div class="buttons are-small" id="lang-switcher">
        <button class="button is-light" data-lang="ru">RU</button>
        <button class="button is-light" data-lang="en">EN</button>
        <button class="button is-light" data-lang="es">ES</button>
      </div>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5" data-i18n="header-title">Stellar Account</p>
            <p class="subtitle is-7" id="network-label" data-i18n="network-mainnet">Mainnet</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label" data-i18n="status-loading">Loading…</span>
        </div>
      </div>

      <p class="is-mono account-address" id="account-id">—</p>

      <div class="mt-2 buttons">
        <button class="button is-small is-light" id="copy-btn" data-i18n="copy-address">
          Скопировать адрес
        </button>
        <a class="button is-small is-link is-light"
           id="btn-bsn"
           target="_blank"
           rel="noreferrer">
          BSN.expert
        </a>
        <a class="button is-small is-link is-light"
           id="btn-scopuly"
           target="_blank"
           rel="noreferrer">
          Scopuly
        </a>
        <a class="button is-small is-link is-light"
           id="btn-stellarchain"
           target="_blank"
           rel="noreferrer">
          StellarChain
        </a>
      </div>

      <div class="mt-3">
        <p class="is-size-7">
          <span data-i18n="sequence-label">Sequence</span>: <span id="seq">—</span><br>
          <span data-i18n="subentries-label">Subentries</span>: <span id="subentries">—</span>
        </p>
      </div>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p data-i18n="error-title">Ошибка</p>
      </div>
      <div class="message-body" id="error-text">
        —
      </div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader" data-i18n="loader-text">Загрузка</progress>

    <!-- BALANCES -->
    <div class="box">
      <p class="title is-6" data-i18n="balances-title">Балансы</p>

      <div id="balance-native" class="mb-3 balance-grid"></div>

      <hr class="my-3">

      <p class="subtitle is-7 has-text-weight-semibold mb-1" data-i18n="assets-title">Ассеты</p>
      <div id="balance-assets" class="mb-3 balance-grid">
        <!-- карточки ассетов -->
      </div>

      <p class="subtitle is-7 has-text-weight-semibold mb-1" data-i18n="pools-title">Пулы</p>
      <div id="balance-pools" class="mb-3 balance-grid">
        <!-- карточки пулов -->
      </div>

      <p class="subtitle is-7 has-text-weight-semibold mb-1" data-i18n="issued-title">Выпущенные ассеты</p>
      <div id="balance-issued" class="balance-grid">
        <!-- карточки выпущенных ассетов -->
      </div>
    </div>

    <!-- SIGNERS -->
    <div class="box">
      <p class="title is-6" data-i18n="signers-title">Подписанты и пороги</p>
      <p class="is-size-7">
        <span data-i18n="thresholds-label">Пороги</span>:
        <span id="thresholds">—</span>
      </p>
      <ul id="signers" class="is-size-7 mt-2">
        <!-- сюда пойдут подписанты -->
      </ul>
    </div>

    <!-- DATA -->
    <div class="box">
      <p class="title is-6" data-i18n="data-title">Data</p>
      <ul id="data" class="is-size-7">
        <!-- сюда пойдут data-поля -->
      </ul>
    </div>

    <!-- BOTTOM ACTIONS -->
    <div class="bottom-actions">
      <div class="buttons">
        <a class="button is-link is-light is-fullwidth"
           id="btn-operations"
           data-i18n="btn-operations">
          Операции
        </a>
      </div>
      <div class="buttons">
        <a class="button is-link is-light is-fullwidth"
           id="btn-offers"
           data-i18n="btn-offers">
          Офферы
        </a>
      </div>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/common`;
    return '/common';
  })();
  const i18nBase = commonBase.replace(/common$/, 'i18n');
  document.getElementById('common-css').href = `${commonBase}.css?5`;
  const { shorten, isLocalLike } = await import(`${commonBase}.js?5`);
  const { initI18n } = await import(`${i18nBase}.js?5`);

  const horizonBase = 'https://horizon.stellar.org'; // на будущее можно сделать переключатель сети
  const defaultAccountId = 'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V';
  const langButtons = Array.from(document.querySelectorAll('#lang-switcher [data-lang]'));
  const i18n = await initI18n({ baseName: 'account' });
  const { t } = i18n;

  let currentAccount = null;
  let issuedRecords = null;
  let statusState = 'loading';
  let lastErrorKey = '';
  let lastErrorDetail = '';

  function getAccountIdFromUrl() {
    const path = window.location.pathname; // /account/GD...
    const parts = path.split('/').filter(Boolean); // ['account', 'GD...']
    if (parts.length >= 2 && parts[0] === 'account') {
      return parts[1];
    }
    // Локальный просмотр файла (file://) — подставляем дефолт для отладки
    if (isLocalLike()) {
      return defaultAccountId;
    }
    return null;
  }

  function formatAssetLabel(asset) {
    if (!asset || asset === 'native') {
      return { text: 'XLM', code: 'XLM', href: null };
    }
    const [code, issuer] = asset.split(':');
    const text = `${code || '—'} · ${issuer ? shorten(issuer) : '—'}`;
    const href = code && issuer
      ? `/assets/${encodeURIComponent(`${code}-${issuer}`)}`
      : null;
    return { text, code: code || '—', href };
  }

  function accountLink(acc) {
    return acc ? `/account/${encodeURIComponent(acc)}` : null;
  }

  function createBalanceCard({ title, subtitle = '', amount = '—', meta = '', href = null }) {
    const card = document.createElement('div');
    card.className = 'box is-size-7';

    const titleHtml = href
      ? `<a class="has-text-weight-semibold" href="${href}">${title}</a>`
      : `<span class="has-text-weight-semibold">${title}</span>`;

    const metaHtml = meta ? `<span class="balance-meta">${meta}</span>` : '';

    card.innerHTML = `
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p>${titleHtml}</p>
            ${subtitle ? `<p class="is-size-7 has-text-grey">${subtitle}</p>` : ''}
          </div>
        </div>
        <div class="level-right">
          <div class="has-text-right is-mono balance-amount">
            <span class="has-text-weight-semibold">${amount}</span>
            ${metaHtml}
          </div>
        </div>
      </div>
    `;

    return card;
  }

  const poolMetaCache = new Map();

  async function describePool(poolId, linkEl, subtitleEl, shareBalance) {
    if (poolMetaCache.has(poolId)) {
      const cached = poolMetaCache.get(poolId);
      if (cached && cached.label) {
        linkEl.textContent = `${t('pool-label')}: ${cached.label}`;
        // Если есть закэшированные данные и передан баланс, можно посчитать
        if (shareBalance && cached.reserves && cached.totalShares) {
          updatePoolShareInfo(subtitleEl, poolId, cached.reserves, cached.totalShares, shareBalance);
        }
        return;
      }
    }

    try {
      const res = await fetch(`${horizonBase}/liquidity_pools/${poolId}`);
      if (!res.ok) throw new Error('load failed');
      const data = await res.json();

      const reserves = data?.reserves || [];
      const totalShares = data?.total_shares || '0';

      // Для заголовка используем только коды (code), без эмитентов
      const labels = reserves.map(r => formatAssetLabel(r.asset).code).filter(Boolean);
      const label = labels.length ? labels.join(' / ') : shorten(poolId);

      // Кэшируем всё, что нужно
      poolMetaCache.set(poolId, { label, reserves, totalShares });

      linkEl.textContent = `${t('pool-label')}: ${label}`;

      if (subtitleEl) {
        subtitleEl.innerHTML = `${t('pool-id-label')}: ${shorten(poolId)}`;
        if (shareBalance) {
          updatePoolShareInfo(subtitleEl, poolId, reserves, totalShares, shareBalance);
        }
      }
    } catch (e) {
      console.error(e);
      // Если ошибка, кэшируем пустой объект или null, чтобы не долбить запросами
      poolMetaCache.set(poolId, { label: null });
    }
  }

  function updatePoolShareInfo(subtitleEl, poolId, reserves, totalSharesStr, userSharesStr) {
    const totalShares = parseFloat(totalSharesStr);
    const userShares = parseFloat(userSharesStr);

    if (!isNaN(totalShares) && !isNaN(userShares) && totalShares > 0) {
      const ratio = userShares / totalShares;
      const parts = reserves.map(r => {
        const amount = parseFloat(r.amount);
        if (isNaN(amount)) return null;
        const myAmount = amount * ratio;
        // Форматирование: до 2 знаков, если число большое, или до 7, если маленькое
        // Простая эвристика для читаемости
        const valStr = myAmount < 0.01 ? myAmount.toFixed(7) : myAmount.toFixed(2);
        // Убираем лишние нули в конце, если это дроби
        const cleanVal = parseFloat(valStr).toString();
        // Используем только код актива (code) для компактности
        const symbol = formatAssetLabel(r.asset).code;
        return `${cleanVal} ${symbol}`;
      }).filter(Boolean);

      if (parts.length) {
        const info = parts.join(' + ');
        // Добавляем новую строку к subtitle
        subtitleEl.innerHTML += `<br><span class="has-text-grey-dark" style="font-size: 0.9em">~ ${info}</span>`;
      }
    }
  }

  function setActiveLangButton(lang) {
    langButtons.forEach((btn) => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('is-primary', isActive);
      btn.classList.toggle('is-light', !isActive);
    });
  }

  function setStatus(state) {
    statusState = state;
    const status = document.getElementById('status-label');
    status.classList.remove('is-danger', 'is-success', 'is-info');
    let key = 'status-loading';
    if (state === 'ok') {
      status.classList.add('is-success');
      key = 'status-ok';
    } else if (state === 'error') {
      status.classList.add('is-danger');
      key = 'status-error';
    } else {
      status.classList.add('is-info');
    }
    status.textContent = t(key);
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.textContent = t('loader-text');
    loader.classList.toggle('is-hidden', !on);
  }

  function showError(messageKey, { detail = '' } = {}) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    lastErrorKey = messageKey || '';
    lastErrorDetail = detail || '';
    const base = messageKey ? t(messageKey) : '';
    const msg = detail ? `${base ? base + ': ' : ''}${detail}` : base;
    text.textContent = msg || detail || '';
    box.classList.remove('is-hidden');
    setStatus('error');
  }

  function clearError() {
    const box = document.getElementById('error-box');
    box.classList.add('is-hidden');
  }

  function renderBalances(account) {
    const nativeEl = document.getElementById('balance-native');
    const assetsEl = document.getElementById('balance-assets');
    const poolsEl = document.getElementById('balance-pools');

    nativeEl.innerHTML = '';
    assetsEl.innerHTML = '';
    poolsEl.innerHTML = '';

    const balances = account.balances || [];
    const native = balances.filter(b => b.asset_type === 'native');
    const assets = balances.filter(b => b.asset_type !== 'native' && b.asset_type !== 'liquidity_pool_shares');
    const pools = balances.filter(b => b.asset_type === 'liquidity_pool_shares');

    if (native.length) {
      const b = native[0];
      const metaParts = [];
      if (b.limit) metaParts.push(`${t('balance-limit')}: ${b.limit}`);
      const card = createBalanceCard({
        title: 'XLM',
        subtitle: t('balance-native-subtitle'),
        amount: b.balance,
        meta: metaParts.length ? metaParts.join(' · ') : ''
      });
      nativeEl.appendChild(card);
    } else {
      nativeEl.innerHTML = `<p class="is-size-7 has-text-grey">${t('balance-no-xlm')}</p>`;
    }

    if (assets.length) {
      assets.forEach(b => {
        const issuer = b.asset_issuer || '';
        const assetId = b.asset_code && issuer ? `${b.asset_code}-${issuer}` : null;
        const extras = [];
        if (b.limit) extras.push(`${t('balance-limit')}: ${b.limit}`);
        if (b.is_authorized === false) extras.push(t('balance-not-authorized'));
        if (b.is_authorized_to_maintain_liabilities === false) extras.push(t('balance-no-maintain'));
        if (b.is_clawback_enabled) extras.push(t('balance-clawback-enabled'));
        const meta = extras.length
          ? `<span class="tag is-light is-size-7" title="${extras.join(' • ')}">★ ${t('balance-details')}</span>`
          : '';

        const card = createBalanceCard({
          title: b.asset_code || '—',
          subtitle: issuer ? `${t('balance-issuer')}: ${shorten(issuer)}` : '',
          amount: b.balance,
          meta,
          href: assetId ? `/assets/${encodeURIComponent(assetId)}` : null
        });
        assetsEl.appendChild(card);
      });
    } else {
      assetsEl.innerHTML = `<p class="is-size-7 has-text-grey">${t('assets-empty')}</p>`;
    }

    if (pools.length) {
      pools.forEach(b => {
        const poolId = b.liquidity_pool_id || '—';
        const card = createBalanceCard({
          title: t('pool-card-title'),
          subtitle: `${t('pool-id-label')}: ${shorten(poolId)}`,
          amount: b.balance,
          href: poolId !== '—' ? `/pool/${encodeURIComponent(poolId)}` : null
        });
        poolsEl.appendChild(card);

        if (poolId !== '—') {
          // Ищем элементы внутри карточки, чтобы обновить их через describePool
          // Заголовок - это первый элемент внутри .level-left
          // createBalanceCard: <div class="level-left"><div><p>TITLE</p>...
          const titleContainer = card.querySelector('.level-left > div > p:first-child');
          const titleEl = titleContainer ? (titleContainer.firstElementChild || titleContainer) : null;

          const subtitleEl = card.querySelector('.level-left > div > p.has-text-grey');

          if (titleEl && subtitleEl) {
            describePool(poolId, titleEl, subtitleEl, b.balance);
          }
        }
      });
    } else {
      poolsEl.innerHTML = `<p class="is-size-7 has-text-grey">${t('pools-empty')}</p>`;
    }
  }

  function renderSignersSection(account) {
    const signersEl = document.getElementById('signers');
    signersEl.innerHTML = '';
    const signers = account?.signers || [];
    signers.forEach(s => {
      const li = document.createElement('li');
      li.className = 'mb-1';

      const link = accountLink(s.key);
      const keyLabel = shorten(s.key);

      li.innerHTML = `
        <span>${s.type}</span><br>
        ${link
          ? `<a class="is-mono is-size-7" href="${link}" title="${s.key}">${keyLabel}</a>`
          : `<code class="is-mono is-size-7">${s.key}</code>`}<br>
        <span>${t('weight-label')}: ${s.weight}</span>
      `;
      signersEl.appendChild(li);
    });
    if (!signers.length) {
      signersEl.textContent = t('signers-empty');
    }
  }

  function renderDataSection(account) {
    const dataEl = document.getElementById('data');
    dataEl.innerHTML = '';
    const dataAttr = account?.data_attr || account?.data || {};
    const entries = Object.entries(dataAttr);
    if (!entries.length) {
      dataEl.textContent = t('data-empty');
    } else {
      entries.forEach(([key, value]) => {
        const li = document.createElement('li');
        li.className = 'mb-1';

        const title = document.createElement('strong');
        title.textContent = key;
        li.appendChild(title);
        li.appendChild(document.createElement('br'));

        let decoded = '';
        try {
          decoded = atob(value);
        } catch (e) {
          decoded = t('data-decode-failed');
        }

        const isAccountId = /^G[A-Z2-7]{55}$/.test(decoded);
        let displayText = decoded;
        if (!isAccountId && decoded.length > 120) {
          displayText = decoded.slice(0, 120) + '…';
        }

        if (isAccountId) {
          const link = document.createElement('a');
          link.href = `/account/${encodeURIComponent(decoded)}`;
          link.textContent = decoded;
          link.className = 'is-size-7 is-mono';
          li.appendChild(link);
        } else {
          const codeEl = document.createElement('code');
          codeEl.className = 'is-mono is-size-7';
          codeEl.textContent = displayText;
          li.appendChild(codeEl);
        }

        dataEl.appendChild(li);
      });
    }
  }

  function renderIssuedAssets(records) {
    const issuedEl = document.getElementById('balance-issued');
    issuedEl.innerHTML = '';

    if (!records.length) {
      issuedEl.textContent = t('issued-empty');
      return;
    }

    records.forEach(asset => {
      const id = asset.asset_code || '—';
      const extras = [];
      if (typeof asset.num_accounts !== 'undefined') {
        extras.push(`${t('issued-holders')}: ${asset.num_accounts}`);
      }
      const card = createBalanceCard({
        title: id,
        subtitle: t('issued-subtitle'),
        amount: asset.amount,
        meta: extras.length ? extras.join(' · ') : '',
        href: `/assets/${encodeURIComponent(`${asset.asset_code}-${asset.asset_issuer}`)}`
      });
      issuedEl.appendChild(card);
    });
  }

  async function loadIssuedAssets(issuer) {
    const issuedEl = document.getElementById('balance-issued');
    issuedEl.textContent = t('issued-loading');
    try {
      const res = await fetch(`${horizonBase}/assets?asset_issuer=${encodeURIComponent(issuer)}&limit=200`);
      if (!res.ok) {
        throw new Error(`Horizon error ${res.status}`);
      }
      const data = await res.json();
      const records = data?._embedded?.records || [];
      issuedRecords = records;
      renderIssuedAssets(records);
    } catch (e) {
      issuedRecords = null;
      issuedEl.textContent = t('issued-error');
      console.error(e);
    }
  }

  function renderAccount(account) {
    currentAccount = account;
    // Header
    document.getElementById('seq').textContent = account.sequence;
    document.getElementById('subentries').textContent = account.subentry_count;
    setStatus('ok');

    // Thresholds
    const th = account.thresholds || {};
    document.getElementById('thresholds').textContent =
      `low=${th.low_threshold}, med=${th.med_threshold}, high=${th.high_threshold}`;

    // Balances
    renderBalances(account);

    // Signers
    renderSignersSection(account);

    // Data
    renderDataSection(account);

    // Внешние ссылки
    const id = account.id;
    document.getElementById('btn-bsn').href =
      `https://bsn.expert/accounts/${id}`;
    document.getElementById('btn-scopuly').href =
      `https://scopuly.com/account/${id}`;
    document.getElementById('btn-stellarchain').href =
      `https://stellarchain.io/accounts/${id}`;
    document.getElementById('btn-operations').href =
      `/operations/${encodeURIComponent(id)}`;
    document.getElementById('btn-offers').href =
      `/offers/${encodeURIComponent(id)}`;

    // Issued assets
    loadIssuedAssets(account.id);
  }

  async function loadAccount() {
    const accountId = getAccountIdFromUrl();
    const accountEl = document.getElementById('account-id');

    if (!accountId) {
      showError('error-no-account-id');
      return;
    }

    accountEl.textContent = accountId;
    clearError();
    setStatus('loading');
    showLoading(true);

    try {
      const res = await fetch(`${horizonBase}/accounts/${accountId}`);
      if (!res.ok) {
        let detail = `Horizon error ${res.status}`;
        try {
          const err = await res.json();
          if (err?.detail) detail = err.detail;
        } catch (_) {
          // ignore
        }
        throw new Error(detail || t('error-unknown'));
      }
      const data = await res.json();
      renderAccount(data);
    } catch (e) {
      console.error(e);
      showError('error-load-account', { detail: e.message || t('error-unknown') });
    } finally {
      showLoading(false);
    }
  }

  // Кнопка "копировать"
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const text = document.getElementById('account-id').textContent;
    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-btn');
      const old = btn.textContent;
      btn.textContent = t('copy-success');
      setTimeout(() => (btn.textContent = old), 1500);
    } catch (e) {
      alert(t('copy-failed'));
    }
  });

  function reapplyLanguage() {
    showLoading(!document.getElementById('loader').classList.contains('is-hidden'));
    setStatus(statusState);
    const errorVisible = !document.getElementById('error-box').classList.contains('is-hidden');
    if (errorVisible) {
      showError(lastErrorKey, { detail: lastErrorDetail });
    }
    if (currentAccount) {
      renderBalances(currentAccount);
      renderSignersSection(currentAccount);
      renderDataSection(currentAccount);
      if (issuedRecords) {
        renderIssuedAssets(issuedRecords);
      }
    }
    setActiveLangButton(i18n.lang());
  }

  setActiveLangButton(i18n.lang());

  langButtons.forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nextLang = btn.dataset.lang;
      await i18n.setLang(nextLang);
      reapplyLanguage();
    });
  });

  // старт
  loadAccount();
</script>

</body>
</html>
