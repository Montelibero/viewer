<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Stellar Account Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bulma через CDN -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <link id="common-css" rel="stylesheet" href="/common.css">
</head>
<body>
<section class="section">
  <div class="container">

    <div class="mb-4">
      <a class="button is-small is-light" href="/">На главную</a>
    </div>

    <!-- HEADER -->
    <div class="box">
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p class="title is-5">Stellar Account</p>
            <p class="subtitle is-7" id="network-label">Mainnet</p>
          </div>
        </div>
        <div class="level-right">
          <span class="tag is-info is-light" id="status-label">Loading…</span>
        </div>
      </div>

      <p class="is-mono account-address" id="account-id">—</p>

      <div class="mt-2 buttons">
        <button class="button is-small is-light" id="copy-btn">
          Скопировать адрес
        </button>
        <a class="button is-small is-link is-light"
           id="btn-bsn"
           target="_blank"
           rel="noreferrer">
          BSN.expert
        </a>
        <a class="button is-small is-link is-light"
           id="btn-scopuly"
           target="_blank"
           rel="noreferrer">
          Scopuly
        </a>
        <a class="button is-small is-link is-light"
           id="btn-stellarchain"
           target="_blank"
           rel="noreferrer">
          StellarChain
        </a>
      </div>

      <div class="mt-3">
        <p class="is-size-7">
          Sequence: <span id="seq">—</span><br>
          Subentries: <span id="subentries">—</span>
        </p>
      </div>
    </div>

    <!-- ERROR MESSAGE -->
    <article class="message is-danger is-hidden" id="error-box">
      <div class="message-header">
        <p>Ошибка</p>
      </div>
      <div class="message-body" id="error-text">
        —
      </div>
    </article>

    <!-- LOADER -->
    <progress class="progress is-small is-primary is-hidden"
              max="100" id="loader">Загрузка</progress>

    <!-- BALANCES -->
    <div class="box">
      <p class="title is-6">Балансы</p>

      <div id="balance-native" class="mb-3 balance-grid"></div>

      <hr class="my-3">

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Ассеты</p>
      <div id="balance-assets" class="mb-3 balance-grid">
        <!-- карточки ассетов -->
      </div>

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Пулы</p>
      <div id="balance-pools" class="mb-3 balance-grid">
        <!-- карточки пулов -->
      </div>

      <p class="subtitle is-7 has-text-weight-semibold mb-1">Выпущенные ассеты</p>
      <div id="balance-issued" class="balance-grid">
        <!-- карточки выпущенных ассетов -->
      </div>
    </div>

    <!-- SIGNERS -->
    <div class="box">
      <p class="title is-6">Подписанты и пороги</p>
      <p class="is-size-7">
        Пороги:
        <span id="thresholds">—</span>
      </p>
      <ul id="signers" class="is-size-7 mt-2">
        <!-- сюда пойдут подписанты -->
      </ul>
    </div>

    <!-- DATA -->
    <div class="box">
      <p class="title is-6">Data</p>
      <ul id="data" class="is-size-7">
        <!-- сюда пойдут data-поля -->
      </ul>
    </div>

    <!-- BOTTOM ACTIONS -->
    <div class="bottom-actions">
      <div class="buttons">
        <a class="button is-link is-light is-fullwidth"
           id="btn-operations">
          Операции
        </a>
      </div>
      <div class="buttons">
        <a class="button is-link is-light is-fullwidth"
           id="btn-offers">
          Офферы
        </a>
      </div>
    </div>

  </div>
</section>

<script type="module">
  const commonBase = (() => {
    if (window.location.protocol === 'file:') return './common';
    const m = window.location.pathname.match(/^(.*\/site)\//);
    if (m) return `${m[1]}/common`;
    return '/common';
  })();
  document.getElementById('common-css').href = `${commonBase}.css`;
  const { shorten, isLocalLike } = await import(`${commonBase}.js`);

  const horizonBase = 'https://horizon.stellar.org'; // на будущее можно сделать переключатель сети
  const defaultAccountId = 'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V';

  function getAccountIdFromUrl() {
    const path = window.location.pathname; // /account/GD...
    const parts = path.split('/').filter(Boolean); // ['account', 'GD...']
    if (parts.length >= 2 && parts[0] === 'account') {
      return parts[1];
    }
    // Локальный просмотр файла (file://) — подставляем дефолт для отладки
    if (isLocalLike()) {
      return defaultAccountId;
    }
    return null;
  }

  function formatAssetLabel(asset) {
    if (!asset || asset === 'native') {
      return { text: 'XLM', href: null };
    }
    const [code, issuer] = asset.split(':');
    const text = `${code || '—'} · ${issuer ? shorten(issuer) : '—'}`;
    const href = code && issuer
      ? `/assets/${encodeURIComponent(`${code}-${issuer}`)}`
      : null;
    return { text, href };
  }

  function accountLink(acc) {
    return acc ? `/account/${encodeURIComponent(acc)}` : null;
  }

  function createBalanceCard({ title, subtitle = '', amount = '—', meta = '', href = null }) {
    const card = document.createElement('div');
    card.className = 'box is-size-7';

    const titleHtml = href
      ? `<a class="has-text-weight-semibold" href="${href}">${title}</a>`
      : `<span class="has-text-weight-semibold">${title}</span>`;

    const metaHtml = meta ? `<span class="balance-meta">${meta}</span>` : '';

    card.innerHTML = `
      <div class="level is-mobile">
        <div class="level-left">
          <div>
            <p>${titleHtml}</p>
            ${subtitle ? `<p class="is-size-7 has-text-grey">${subtitle}</p>` : ''}
          </div>
        </div>
        <div class="level-right">
          <div class="has-text-right is-mono balance-amount">
            <span class="has-text-weight-semibold">${amount}</span>
            ${metaHtml}
          </div>
        </div>
      </div>
    `;

    return card;
  }

  const poolMetaCache = new Map();

  async function describePool(poolId, linkEl, subtitleEl) {
    if (poolMetaCache.has(poolId)) {
      const label = poolMetaCache.get(poolId);
      if (label) linkEl.textContent = `Пул: ${label}`;
      return;
    }
    try {
      const res = await fetch(`${horizonBase}/liquidity_pools/${poolId}`);
      if (!res.ok) throw new Error('load failed');
      const data = await res.json();
      const reserves = data?.reserves || [];
      const labels = reserves.map(r => formatAssetLabel(r.asset).text).filter(Boolean);
      const label = labels.length ? labels.join(' / ') : shorten(poolId);
      poolMetaCache.set(poolId, label);
      linkEl.textContent = `Пул: ${label}`;
      if (subtitleEl) {
        subtitleEl.textContent = `ID: ${shorten(poolId)}`;
      }
    } catch (e) {
      poolMetaCache.set(poolId, null);
    }
  }

  function showLoading(on) {
    const loader = document.getElementById('loader');
    loader.classList.toggle('is-hidden', !on);
  }

  function showError(message) {
    const box = document.getElementById('error-box');
    const text = document.getElementById('error-text');
    text.textContent = message;
    box.classList.remove('is-hidden');
    const status = document.getElementById('status-label');
    status.textContent = 'Error';
    status.classList.remove('is-info');
    status.classList.add('is-danger');
  }

  function clearError() {
    const box = document.getElementById('error-box');
    box.classList.add('is-hidden');
  }

  function renderBalances(account) {
    const nativeEl = document.getElementById('balance-native');
    const assetsEl = document.getElementById('balance-assets');
    const poolsEl = document.getElementById('balance-pools');

    nativeEl.innerHTML = '';
    assetsEl.innerHTML = '';
    poolsEl.innerHTML = '';

    const balances = account.balances || [];
    const native = balances.filter(b => b.asset_type === 'native');
    const assets = balances.filter(b => b.asset_type !== 'native' && b.asset_type !== 'liquidity_pool_shares');
    const pools = balances.filter(b => b.asset_type === 'liquidity_pool_shares');

    if (native.length) {
      const b = native[0];
      const metaParts = [];
      if (b.limit) metaParts.push(`limit: ${b.limit}`);
      const card = createBalanceCard({
        title: 'XLM',
        subtitle: 'native',
        amount: b.balance,
        meta: metaParts.length ? metaParts.join(' · ') : ''
      });
      nativeEl.appendChild(card);
    } else {
      nativeEl.innerHTML = '<p class="is-size-7 has-text-grey">Нет XLM баланса.</p>';
    }

    if (assets.length) {
      assets.forEach(b => {
        const issuer = b.asset_issuer || '';
        const assetId = b.asset_code && issuer ? `${b.asset_code}-${issuer}` : null;
        const extras = [];
        if (b.limit) extras.push(`limit: ${b.limit}`);
        if (b.is_authorized === false) extras.push('not authorized');
        if (b.is_authorized_to_maintain_liabilities === false) extras.push('no maintain liabilities');
        if (b.is_clawback_enabled) extras.push('clawback enabled');
        const meta = extras.length
          ? `<span class="tag is-light is-size-7" title="${extras.join(' • ')}">★ детали</span>`
          : '';

        const card = createBalanceCard({
          title: b.asset_code || '—',
          subtitle: issuer ? `issuer: ${shorten(issuer)}` : '',
          amount: b.balance,
          meta,
          href: assetId ? `/assets/${encodeURIComponent(assetId)}` : null
        });
        assetsEl.appendChild(card);
      });
    } else {
      assetsEl.innerHTML = '<p class="is-size-7 has-text-grey">Нет trustline-ассетов.</p>';
    }

    if (pools.length) {
      pools.forEach(b => {
        const poolId = b.liquidity_pool_id || '—';
        const card = createBalanceCard({
          title: 'Пул ликвидности',
          subtitle: `ID: ${shorten(poolId)}`,
          amount: b.balance,
          href: poolId !== '—' ? `/pool/${encodeURIComponent(poolId)}` : null
        });
        poolsEl.appendChild(card);
      });
    } else {
      poolsEl.innerHTML = '<p class="is-size-7 has-text-grey">Нет пулов.</p>';
    }
  }

  async function loadIssuedAssets(issuer) {
    const issuedEl = document.getElementById('balance-issued');
    issuedEl.textContent = 'Загрузка…';
    try {
      const res = await fetch(`${horizonBase}/assets?asset_issuer=${encodeURIComponent(issuer)}&limit=200`);
      if (!res.ok) {
        throw new Error(`Horizon error ${res.status}`);
      }
      const data = await res.json();
      const records = data?._embedded?.records || [];
      issuedEl.innerHTML = '';

      if (!records.length) {
        issuedEl.textContent = 'Нет выпущенных ассетов.';
        return;
      }

      records.forEach(asset => {
        const id = asset.asset_code || '—';
        const extras = [];
        if (typeof asset.num_accounts !== 'undefined') {
          extras.push(`holders: ${asset.num_accounts}`);
        }
        const card = createBalanceCard({
          title: id,
          subtitle: 'issuer: этот аккаунт',
          amount: asset.amount,
          meta: extras.length ? extras.join(' · ') : '',
          href: `/assets/${encodeURIComponent(`${asset.asset_code}-${asset.asset_issuer}`)}`
        });
        issuedEl.appendChild(card);
      });
    } catch (e) {
      issuedEl.textContent = 'Не удалось загрузить выпущенные ассеты.';
      console.error(e);
    }
  }

  function renderAccount(account) {
    // Header
    document.getElementById('seq').textContent = account.sequence;
    document.getElementById('subentries').textContent = account.subentry_count;
    document.getElementById('status-label').textContent = 'OK';
    document.getElementById('status-label').classList.remove('is-danger');
    document.getElementById('status-label').classList.add('is-success');

    // Thresholds
    const th = account.thresholds || {};
    document.getElementById('thresholds').textContent =
      `low=${th.low_threshold}, med=${th.med_threshold}, high=${th.high_threshold}`;

    // Balances
    renderBalances(account);

    // Signers
    const signersEl = document.getElementById('signers');
    signersEl.innerHTML = '';
    account.signers.forEach(s => {
      const li = document.createElement('li');
      li.className = 'mb-1';

      const link = accountLink(s.key);
      const keyLabel = shorten(s.key);

      li.innerHTML = `
        <span>${s.type}</span><br>
        ${link
          ? `<a class="is-mono is-size-7" href="${link}" title="${s.key}">${keyLabel}</a>`
          : `<code class="is-mono is-size-7">${s.key}</code>`}<br>
        <span>weight: ${s.weight}</span>
      `;
      signersEl.appendChild(li);
    });
    if (!account.signers.length) {
      signersEl.textContent = 'Нет подписантов.';
    }

    // Data
    const dataEl = document.getElementById('data');
    dataEl.innerHTML = '';
    const dataAttr = account.data_attr || account.data || {};
    const entries = Object.entries(dataAttr);
    if (!entries.length) {
      dataEl.textContent = 'Нет data-полей.';
    } else {
      entries.forEach(([key, value]) => {
        const li = document.createElement('li');
        li.className = 'mb-1';

        const title = document.createElement('strong');
        title.textContent = key;
        li.appendChild(title);
        li.appendChild(document.createElement('br'));

        let decoded = '';
        try {
          decoded = atob(value);
        } catch (e) {
          decoded = '[не удалось декодировать base64]';
        }

        const isAccountId = /^G[A-Z2-7]{55}$/.test(decoded);
        let displayText = decoded;
        if (!isAccountId && decoded.length > 120) {
          displayText = decoded.slice(0, 120) + '…';
        }

        if (isAccountId) {
          const link = document.createElement('a');
          link.href = `/account/${encodeURIComponent(decoded)}`;
          link.textContent = decoded;
          link.className = 'is-size-7 is-mono';
          li.appendChild(link);
        } else {
          const codeEl = document.createElement('code');
          codeEl.className = 'is-mono is-size-7';
          codeEl.textContent = displayText;
          li.appendChild(codeEl);
        }

        dataEl.appendChild(li);
      });
    }

    // Внешние ссылки
    const id = account.id;
    document.getElementById('btn-bsn').href =
      `https://bsn.expert/accounts/${id}`;
    document.getElementById('btn-scopuly').href =
      `https://scopuly.com/account/${id}`;
    document.getElementById('btn-stellarchain').href =
      `https://stellarchain.io/accounts/${id}`;
    document.getElementById('btn-operations').href =
      `/operations/${encodeURIComponent(id)}`;
    document.getElementById('btn-offers').href =
      `/offers/${encodeURIComponent(id)}`;

    // Issued assets
    loadIssuedAssets(account.id);
  }

  async function loadAccount() {
    const accountId = getAccountIdFromUrl();
    const accountEl = document.getElementById('account-id');

    if (!accountId) {
      showError('Не удалось определить accountId из URL.');
      return;
    }

    accountEl.textContent = accountId;
    clearError();
    showLoading(true);

    try {
      const res = await fetch(`${horizonBase}/accounts/${accountId}`);
      if (!res.ok) {
        let detail = `Horizon error ${res.status}`;
        try {
          const err = await res.json();
          if (err?.detail) detail = err.detail;
        } catch (_) {
          // ignore
        }
        throw new Error(detail);
      }
      const data = await res.json();
      renderAccount(data);
    } catch (e) {
      console.error(e);
      showError(e.message || 'Неизвестная ошибка при загрузке аккаунта.');
    } finally {
      showLoading(false);
    }
  }

  // Кнопка "копировать"
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const text = document.getElementById('account-id').textContent;
    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById('copy-btn');
      const old = btn.textContent;
      btn.textContent = 'Скопировано';
      setTimeout(() => (btn.textContent = old), 1500);
    } catch (e) {
      alert('Не удалось скопировать в буфер обмена.');
    }
  });

  // старт
  loadAccount();
</script>

</body>
</html>
